
<!DOCTYPE html>
<html>
<head>
    <title>Directional Lines Map / Bản đồ đường định hướng</title>
    <meta charset="utf-8" />
    <style>
        html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 85%; }
        #inputForm { padding: 10px; background: #f0f0f0; }
        input, button { margin: 3px; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
</head>
<body>
    <div id="inputForm">
        <label>Coordinates / Toạ độ (lat, lon):</label>
        <input type="text" id="coords" value="-25.944915, 32.561912" size="25">
        <label>Name / Tên điểm:</label>
        <input type="text" id="pointName" value="MAC278">
        <label>Length (m) / Chiều dài (m):</label>
        <input type="number" id="length" value="200"><br>
        <label>Angle 1 (Red / Đỏ):</label>
        <input type="number" id="angle1" value="60">
        <label>Angle 2 (Yellow / Vàng):</label>
        <input type="number" id="angle2" value="180">
        <label>Angle 3 (Blue / Xanh):</label>
        <input type="number" id="angle3" value="300">
        <button onclick="drawLines()">Draw / Vẽ</button>
        <button onclick="exportKML()">Export KML</button>
        <button onclick="alert('Use your computer screenshot tool to capture image. / Dùng công cụ chụp màn hình của máy tính để lưu ảnh.')">Share Image / Chia sẻ ảnh</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([-25.944915, 32.561912], 17);
        var marker;
        var lines = [];
        var currentData = {};

        L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        function toRad(deg) { return deg * Math.PI / 180; }
        function toDeg(rad) { return rad * 180 / Math.PI; }

        function destinationPoint(lat, lon, distance, bearing) {
            var R = 6371e3;
            var φ1 = toRad(lat), λ1 = toRad(lon), θ = toRad(bearing), δ = distance / R;
            var φ2 = Math.asin(Math.sin(φ1) * Math.cos(δ) +
                Math.cos(φ1) * Math.sin(δ) * Math.cos(θ));
            var λ2 = λ1 + Math.atan2(Math.sin(θ) * Math.sin(δ) * Math.cos(φ1),
                                     Math.cos(δ) - Math.sin(φ1) * Math.sin(φ2));
            return [toDeg(φ2), toDeg(λ2)];
        }

        function drawLines() {
            let coords = document.getElementById("coords").value.split(",");
            let lat = parseFloat(coords[0].trim());
            let lon = parseFloat(coords[1].trim());
            let name = document.getElementById("pointName").value;
            let length = parseFloat(document.getElementById("length").value);
            let angles = [
                { angle: parseFloat(document.getElementById("angle1").value), color: "ff0000ff", label: "Red" },
                { angle: parseFloat(document.getElementById("angle2").value), color: "ff00ffff", label: "Yellow" },
                { angle: parseFloat(document.getElementById("angle3").value), color: "ffff0000", label: "Blue" }
            ];

            if (marker) map.removeLayer(marker);
            lines.forEach(line => map.removeLayer(line));
            lines = [];

            marker = L.marker([lat, lon]).addTo(map).bindPopup(name).openPopup();
            map.setView([lat, lon], 18);

            currentData = { name, lat, lon, length, angles, points: [] };

            angles.forEach(a => {
                let [lat2, lon2] = destinationPoint(lat, lon, length, a.angle);
                lines.push(L.polyline([[lat, lon], [lat2, lon2]], { color: a.label.toLowerCase(), weight: 4 }).addTo(map));
                currentData.points.push({ lat2, lon2, angle: a.angle, color: a.color, label: a.label });
            });
        }

        function exportKML() {
            if (!currentData.name) return alert("Draw first / Vẽ trước đã");

            let kml = `<?xml version="1.0" ?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>
<Placemark><name>${currentData.name}</name><Point><coordinates>${currentData.lon},${currentData.lat},0</coordinates></Point></Placemark>
`;

            currentData.points.forEach((p, i) => {
                kml += `<Placemark><name>Line ${p.label}</name><Style><LineStyle><color>${p.color}</color><width>4</width></LineStyle></Style>
<LineString><tessellate>1</tessellate><coordinates>${currentData.lon},${currentData.lat},0 ${p.lon2},${p.lat2},0</coordinates></LineString></Placemark>
`;
            });

            kml += "</Document></kml>";
            const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = currentData.name + ".kml";
            link.click();
        }
    </script>
</body>
</html>
