<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Directional Lines Bilingual (Satellite Map)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea, input { width: 100%; margin-bottom: 10px; padding: 8px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    #map { height: 500px; margin-top: 20px; position: relative; }
    button { padding: 10px 20px; font-size: 16px; margin-right: 10px; }
    #info, #summary {
      position: absolute;
      left: 10px;
      background: rgba(255,255,255,0.8);
      padding: 6px 10px;
      border-radius: 5px;
      font-size: 14px;
    }
    #info { bottom: 60px; }
    #summary { bottom: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Nhập thông tin / Enter Information</h2>
  <label for="point">Toạ độ (dạng bất kỳ):</label>
  <textarea id="point" rows="2">-25.9493454, 32.5620781</textarea>

  <label for="name">Tên điểm / Point Name:</label>
  <textarea id="name" rows="2">MAC278</textarea>

  <label for="length">Độ dài mỗi đường (m) / Line Length (m):</label>
  <textarea id="length" rows="1">100</textarea>

  <label>Góc 1 / Angle 1 (degrees):</label>
  <textarea id="angle1" rows="1">60</textarea>

  <label>Góc 2 / Angle 2 (degrees):</label>
  <textarea id="angle2" rows="1">180</textarea>

  <label>Góc 3 / Angle 3 (degrees):</label>
  <textarea id="angle3" rows="1">300</textarea>

  <button onclick="drawLines()">Vẽ đường / Draw Lines</button>
  <button onclick="downloadKML()">Xuất KML / Export KML</button>
  <button onclick="captureMap()">Lưu ảnh / Save Image</button>

  <div id="map">
    <div id="info"></div>
    <div id="summary"></div>
  </div>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    let map;
    let lines = [];
    let pointData = {};

    function parseCoordinate(input) {
      const cleaned = input.replace(/[(),]/g, ' ').replace(/\s+/g, ' ').trim();
      const parts = cleaned.split(' ');
      if (parts.length >= 2) {
        return { lat: parseFloat(parts[0]), lng: parseFloat(parts[1]) };
      }
      return null;
    }

    function drawLines() {
      const pointInput = document.getElementById("point").value;
      const point = parseCoordinate(pointInput);
      const name = document.getElementById("name").value;
      const length = parseFloat(document.getElementById("length").value);
      const angles = [
        parseFloat(document.getElementById("angle1").value),
        parseFloat(document.getElementById("angle2").value),
        parseFloat(document.getElementById("angle3").value)
      ];

      if (!point || angles.some(isNaN) || isNaN(length)) {
        alert("Vui lòng nhập đúng định dạng. Please enter correct format.");
        return;
      }

      pointData = { point, name, length, angles };

      if (!map) {
        map = new google.maps.Map(document.getElementById("map"), {
          center: point,
          zoom: 20,
          mapTypeId: "satellite",
          gestureHandling: "auto"
        });
      } else {
        map.setCenter(point);
        lines.forEach(line => line.setMap(null));
        lines = [];
      }

      new google.maps.Marker({
        position: point,
        map: map,
        title: name
      });

      const colors = ["#FF0000", "#FFFF00", "#00008B"];
      const R = 6378137;

      angles.forEach((angle, idx) => {
        const rad = angle * Math.PI / 180;
        const dx = length * Math.sin(rad);
        const dy = length * Math.cos(rad);

        const destLat = point.lat + (dy / R) * (180 / Math.PI);
        const destLng = point.lng + (dx / (R * Math.cos(point.lat * Math.PI / 180))) * (180 / Math.PI);

        const line = new google.maps.Polyline({
          path: [point, { lat: destLat, lng: destLng }],
          geodesic: true,
          strokeColor: colors[idx],
          strokeOpacity: 1.0,
          strokeWeight: 4,
          map: map
        });
        lines.push(line);
      });

      document.getElementById("info").textContent = `${name}: ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)} | Độ dài: ${length}m | Góc: ${angles.join(", ")}`;
      document.getElementById("summary").textContent = `Tên điểm: ${name} | Toạ độ: ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)} | Độ dài: ${length}m | Góc: ${angles.join(", ")}`;
    }

    function downloadKML() {
      const { point, name, length, angles } = pointData;
      const colors = ["ff0000ff", "ff00ffff", "ffff0000"];
      const R = 6378137;
      let kml = `<?xml version="1.0" ?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n  <Placemark><name>${name}</name><Point><coordinates>${point.lng},${point.lat},0</coordinates></Point></Placemark>\n`;
      angles.forEach((angle, idx) => {
        const rad = angle * Math.PI / 180;
        const dx = length * Math.sin(rad);
        const dy = length * Math.cos(rad);
        const destLat = point.lat + (dy / R) * (180 / Math.PI);
        const destLng = point.lng + (dx / (R * Math.cos(point.lat * Math.PI / 180))) * (180 / Math.PI);
        kml += `<Placemark><Style><LineStyle><color>${colors[idx]}</color><width>4</width></LineStyle></Style><LineString><tessellate>1</tessellate><coordinates>${point.lng},${point.lat},0 ${destLng},${destLat},0</coordinates></LineString></Placemark>\n`;
      });
      kml += `</Document></kml>`;
      const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name}.kml`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function captureMap() {
      html2canvas(document.getElementById("map")).then(canvas => {
        const link = document.createElement('a');
        link.download = `${pointData.name}.png`;
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    window.onload = drawLines;
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxOrCC56tuPjujnYB53luYRqe2aN-fvik"></script>
</body>
</html>
